<%- include('../partials/header') %>
    <!-- Load HTML5-QRCode Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <div class="max-w-3xl mx-auto py-4 px-4 sm:px-6 lg:px-8 pb-20">

        <!-- Header -->
        <div class="mb-6">
            <h3 class="text-xl font-bold text-gray-900">Add Item</h3>
            <p class="text-sm text-gray-500">Quickly add food to your inventory.</p>
        </div>

        <!-- Quick Add Suggestions (Collapsible) -->
        <div class="mb-8 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <button id="toggle-suggestions" type="button"
                class="w-full flex justify-between items-center px-4 py-3 bg-indigo-50 hover:bg-indigo-100 transition-colors">
                <span class="text-sm font-semibold text-indigo-700 flex items-center">
                    <i class="fas fa-bolt mr-2"></i> Quick Add Suggestions
                </span>
                <i class="fas fa-chevron-down text-indigo-500 transition-transform duration-200"
                    id="suggestion-icon"></i>
            </button>

            <div id="suggestions-list" class="hidden">
                <div class="p-2 grid grid-cols-1 gap-1 max-h-60 overflow-y-auto">
                    <!-- Suggestion Items -->
                    <div onclick="fillItem('Milk', 1, 7)"
                        class="flex justify-between items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer active:bg-gray-100 transition-colors border border-transparent hover:border-indigo-100 group">
                        <div class="flex items-center">
                            <div
                                class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-3 text-xs">
                                ü•õ</div>
                            <div>
                                <p class="font-medium text-gray-800 text-sm">Milk</p>
                                <p class="text-xs text-gray-400"> Shelf: ~7 days</p>
                            </div>
                        </div>
                        <button type="button"
                            class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-all shadow-sm">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <div onclick="fillItem('Eggs', 1, 21)"
                        class="flex justify-between items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer active:bg-gray-100 transition-colors border border-transparent hover:border-indigo-100 group">
                        <div class="flex items-center">
                            <div
                                class="w-8 h-8 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center mr-3 text-xs">
                                ü•ö</div>
                            <div>
                                <p class="font-medium text-gray-800 text-sm">Eggs</p>
                                <p class="text-xs text-gray-400"> Shelf: ~21 days</p>
                            </div>
                        </div>
                        <button type="button"
                            class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-all shadow-sm">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <div onclick="fillItem('Bread', 1, 5)"
                        class="flex justify-between items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer active:bg-gray-100 transition-colors border border-transparent hover:border-indigo-100 group">
                        <div class="flex items-center">
                            <div
                                class="w-8 h-8 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center mr-3 text-xs">
                                üçû</div>
                            <div>
                                <p class="font-medium text-gray-800 text-sm">Bread</p>
                                <p class="text-xs text-gray-400"> Shelf: ~5 days</p>
                            </div>
                        </div>
                        <button type="button"
                            class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-all shadow-sm">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <div onclick="fillItem('Bananas', 1, 4)"
                        class="flex justify-between items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer active:bg-gray-100 transition-colors border border-transparent hover:border-indigo-100 group">
                        <div class="flex items-center">
                            <div
                                class="w-8 h-8 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center mr-3 text-xs">
                                üçå</div>
                            <div>
                                <p class="font-medium text-gray-800 text-sm">Bananas</p>
                                <p class="text-xs text-gray-400"> Shelf: ~4 days</p>
                            </div>
                        </div>
                        <button type="button"
                            class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-all shadow-sm">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <div class="bg-white shadow-lg rounded-xl overflow-hidden">
            <div class="p-5">
                <form action="/inventory/add" method="POST" id="add-item-form">

                    <!-- Barcode Scanner Trigger & Manual Input -->
                    <div class="mb-6">
                        <button type="button" id="start-scan-btn"
                            class="w-full mb-3 flex justify-center items-center py-4 px-4 border border-emerald-500 border-dashed rounded-xl text-sm font-medium text-emerald-700 bg-emerald-50 hover:bg-emerald-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all active:scale-[0.98]">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-barcode text-2xl mb-1"></i>
                                <span>Scan Barcode</span>
                            </div>
                        </button>

                        <!-- Manual Barcode Fallback (Toggleable or Visible) -->
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-keyboard text-gray-400"></i>
                            </div>
                            <input type="text" name="barcode" id="barcode"
                                class="focus:ring-emerald-500 focus:border-emerald-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-lg py-3"
                                placeholder="Or type barcode manually...">
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Name Input -->
                        <div>
                            <label for="name" class="block text-sm font-semibold text-gray-700 mb-1">Item Name</label>
                            <input type="text" name="name" id="name" required
                                class="appearance-none block w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm transition-shadow"
                                placeholder="e.g. Greek Yogurt">
                        </div>

                        <!-- Quantity Stepper Input -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Number of Products</label>
                            <div
                                class="flex items-center justify-between bg-gray-50 rounded-xl p-2 border border-gray-200">
                                <!-- Minus Button -->
                                <button type="button" onclick="adjustQuantity(-1)"
                                    class="w-14 h-14 flex items-center justify-center rounded-lg bg-white text-gray-500 shadow-sm border border-gray-200 hover:text-red-500 active:bg-gray-100 focus:outline-none transition-all touch-manipulation">
                                    <i class="fas fa-minus text-xl"></i>
                                </button>

                                <!-- Display Value -->
                                <div class="flex-1 text-center select-none">
                                    <span id="quantityDisplay" class="text-3xl font-bold text-gray-800">1</span>
                                    <input type="hidden" name="quantity" id="quantity" value="1">
                                </div>

                                <!-- Plus Button -->
                                <button type="button" onclick="adjustQuantity(1)"
                                    class="w-14 h-14 flex items-center justify-center rounded-lg bg-white text-gray-500 shadow-sm border border-gray-200 hover:text-emerald-500 active:bg-gray-100 focus:outline-none transition-all touch-manipulation">
                                    <i class="fas fa-plus text-xl"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Age Stepper & Shelf Life Grid -->
                        <div class="grid grid-cols-1 gap-6">
                            <!-- Shelf Life Input -->
                            <div>
                                <label for="shelfLife" class="block text-sm font-semibold text-gray-700 mb-1">Shelf Life
                                    (Days)</label>
                                <input type="number" name="shelfLife" id="shelfLife" required min="1"
                                    class="appearance-none block w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm"
                                    placeholder="7">
                            </div>

                            <!-- Age Stepper Input -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">How old is it?
                                    (Days)</label>
                                <div
                                    class="flex items-center justify-between bg-gray-50 rounded-xl p-2 border border-gray-200">
                                    <!-- Minus Button -->
                                    <button type="button" onclick="adjustAge(-1)"
                                        class="w-14 h-14 flex items-center justify-center rounded-lg bg-white text-gray-500 shadow-sm border border-gray-200 hover:text-red-500 active:bg-gray-100 focus:outline-none transition-all touch-manipulation">
                                        <i class="fas fa-minus text-xl"></i>
                                    </button>

                                    <!-- Display Value -->
                                    <div class="flex-1 text-center select-none">
                                        <span id="daysOldDisplay" class="text-3xl font-bold text-gray-800">0</span>
                                        <span class="text-xs text-gray-500 block">days ago</span>
                                        <input type="hidden" name="daysOld" id="daysOld" value="0">
                                    </div>

                                    <!-- Plus Button -->
                                    <button type="button" onclick="adjustAge(1)"
                                        class="w-14 h-14 flex items-center justify-center rounded-lg bg-white text-gray-500 shadow-sm border border-gray-200 hover:text-emerald-500 active:bg-gray-100 focus:outline-none transition-all touch-manipulation">
                                        <i class="fas fa-plus text-xl"></i>
                                    </button>
                                </div>
                                <p class="mt-2 text-center text-xs text-gray-400">0 means bought today</p>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="mt-8">
                        <button type="submit"
                            class="w-full flex justify-center py-4 px-4 border border-transparent rounded-xl shadow-md text-base font-semibold text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all active:scale-[0.98]">
                            Save Item
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scanner Modal Overlay -->
    <div id="scanner-modal"
        class="fixed inset-0 z-[100] hidden bg-black bg-opacity-95 flex flex-col justify-center items-center">
        <!-- Close Button -->
        <button id="close-scanner" type="button"
            class="absolute top-4 right-4 text-white p-3 rounded-full bg-gray-800 hover:bg-gray-700 focus:outline-none z-[110] touch-manipulation">
            <i class="fas fa-times text-2xl"></i>
        </button>

        <div class="w-full max-w-md px-4 relative flex flex-col h-full justify-center">
            <div class="text-white text-center mb-6">
                <h3 class="text-xl font-bold">Scan Barcode</h3>
                <p class="text-sm text-gray-300">Point camera at a product label</p>
            </div>

            <!-- Scanner Viewport -->
            <div id="reader"
                class="w-full bg-black rounded-2xl overflow-hidden border-2 border-emerald-500 shadow-2xl relative">
            </div>

            <!-- Status Text -->
            <div id="scanner-status" class="text-center mt-6 text-emerald-400 font-medium min-h-[24px]"></div>
        </div>
    </div>

    <script>
        // Quick Add Logic
        function fillItem(name, qty, shelf) {
            document.getElementById('name').value = name;

            // Update Quantity Stepper
            document.getElementById('quantity').value = qty;
            document.getElementById('quantityDisplay').textContent = qty;

            document.getElementById('shelfLife').value = shelf;

            // Visual feedback
            const form = document.getElementById('add-item-form');
            // Smooth scroll to form
            form.scrollIntoView({ behavior: 'smooth', block: 'start' });

            const nameField = document.getElementById('name');
            nameField.classList.add('ring-2', 'ring-indigo-500', 'border-indigo-500');
            setTimeout(() => {
                nameField.classList.remove('ring-2', 'ring-indigo-500', 'border-indigo-500');
            }, 800);

            // Collapse suggestions
            const suggestionsList = document.getElementById('suggestions-list');
            const suggestionsIcon = document.getElementById('suggestion-icon');
            if (!suggestionsList.classList.contains('hidden')) {
                suggestionsList.classList.add('hidden');
                suggestionsIcon.style.transform = 'rotate(0deg)';
            }
        }

        // Toggle Suggestions
        document.addEventListener('DOMContentLoaded', () => {
            const suggestionsBtn = document.getElementById('toggle-suggestions');
            const suggestionsList = document.getElementById('suggestions-list');
            const suggestionsIcon = document.getElementById('suggestion-icon');

            if (suggestionsBtn) {
                suggestionsBtn.addEventListener('click', () => {
                    suggestionsList.classList.toggle('hidden');
                    suggestionsIcon.style.transform = suggestionsList.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
                });
                // Default open
                suggestionsList.classList.remove('hidden');
                suggestionsIcon.style.transform = 'rotate(180deg)';
            }
        });

        // Quantity Stepper Logic
        function adjustQuantity(delta) {
            const input = document.getElementById('quantity');
            const display = document.getElementById('quantityDisplay');
            let currentVal = parseInt(input.value) || 1;

            let newVal = currentVal + delta;
            if (newVal < 1) newVal = 1;

            input.value = newVal;
            display.textContent = newVal;
        }

        // Age Stepper Logic
        function adjustAge(delta) {
            const input = document.getElementById('daysOld');
            const display = document.getElementById('daysOldDisplay');
            let currentVal = parseInt(input.value) || 0;

            let newVal = currentVal + delta;
            if (newVal < 0) newVal = 0;

            input.value = newVal;
            display.textContent = newVal;
        }

        // Scanner Logic
        document.addEventListener('DOMContentLoaded', () => {
            const startBtn = document.getElementById('start-scan-btn');
            const closeBtn = document.getElementById('close-scanner');
            const modal = document.getElementById('scanner-modal');
            const statusText = document.getElementById('scanner-status');
            const nameInput = document.getElementById('name');
            const barcodeInput = document.getElementById('barcode');

            let html5QrcodeScanner = null;
            let isScanning = false;

            function openScanner() {
                modal.classList.remove('hidden');
                startScanning();
            }

            function closeScanner() {
                if (html5QrcodeScanner && isScanning) {
                    html5QrcodeScanner.stop().then(() => {
                        modal.classList.add('hidden');
                        isScanning = false;
                        statusText.textContent = '';
                    }).catch(err => {
                        console.error("Failed to stop scanner", err);
                        modal.classList.add('hidden');
                    });
                } else {
                    modal.classList.add('hidden');
                }
            }

            function startScanning() {
                if (!window.isSecureContext) {
                    alert("Camera access requires HTTPS. Please accept any permission prompts.");
                }

                statusText.textContent = "Requesting camera...";
                html5QrcodeScanner = new Html5Qrcode("reader");

                const config = { fps: 10, qrbox: { width: 250, height: 250 } };

                html5QrcodeScanner.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanFailure
                ).then(() => {
                    isScanning = true;
                    statusText.textContent = "Scanning...";
                }).catch(err => {
                    console.error("Error starting scanner", err);
                    statusText.innerHTML = "Error: Camera access denied. HTTPS required.";
                    alert("Camera access failed. Please use the manual barcode field below.");
                    closeScanner();
                });
            }

            async function onScanSuccess(decodedText, decodedResult) {
                if (isScanning) {
                    await html5QrcodeScanner.stop();
                    isScanning = false;
                    modal.classList.add('hidden');
                }

                if (barcodeInput) barcodeInput.value = decodedText;

                // Visual loading state
                const originalContent = startBtn.innerHTML;
                startBtn.innerHTML = '<div class="flex flex-col items-center"><i class="fas fa-spinner fa-spin text-2xl mb-1"></i><span>Fetching...</span></div>';
                startBtn.disabled = true;

                try {
                    const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${decodedText}.json`);
                    const data = await response.json();

                    if (data.status === 1 && data.product.product_name) {
                        nameInput.value = data.product.product_name;
                        nameInput.scrollIntoView({ behavior: "smooth", block: "center" });
                        nameInput.classList.add('ring-2', 'ring-emerald-500');
                        setTimeout(() => nameInput.classList.remove('ring-2', 'ring-emerald-500'), 1000);
                    } else {
                        alert("Product scanned but details not found. Please enter name manually.");
                        nameInput.focus();
                    }
                } catch (error) {
                    console.error("API Error", error);
                    alert("Scan successful, but could not fetch details.");
                } finally {
                    startBtn.innerHTML = originalContent;
                    startBtn.disabled = false;
                }
            }

            function onScanFailure(error) {
                // ignore
            }

            if (startBtn) startBtn.addEventListener('click', openScanner);
            if (closeBtn) closeBtn.addEventListener('click', closeScanner);
        });
    </script>

    <%- include('../partials/footer') %>