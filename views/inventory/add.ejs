<%- include('../partials/header') %>
    <!-- Load HTML5-QRCode Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <div class="max-w-3xl mx-auto py-4 px-4 sm:px-6 lg:px-8 pb-20">

        <!-- Header -->
        <div class="mb-6">
            <h3 class="text-xl font-bold text-gray-900">Add Item</h3>
            <p class="text-sm text-gray-500">Quickly add food to your inventory.</p>
        </div>

        <!-- Quick Add Suggestions (Collapsible) -->
        <div class="mb-8 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <button id="toggle-suggestions" type="button"
                class="w-full flex justify-between items-center px-4 py-3 bg-indigo-50 hover:bg-indigo-100 transition-colors">
                <span class="text-sm font-semibold text-indigo-700 flex items-center">
                    <i class="fas fa-bolt mr-2"></i> Quick Add Suggestions
                </span>
                <i class="fas fa-chevron-down text-indigo-500 transition-transform duration-200"
                    id="suggestion-icon"></i>
            </button>

            <div id="suggestions-list" class="hidden transition-all duration-300 ease-in-out">
                <div
                    class="p-2 grid grid-cols-1 gap-1 max-h-60 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent">
                    <% /* suggestions passed from controller */ %>


                        <% suggestions.forEach(function(item) { %>
                            <div onclick="fillItem('<%= item.name %>', <%= item.qty %>, <%= item.shelf %>)"
                                class="flex justify-between items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer active:bg-gray-100 transition-colors border border-transparent hover:border-indigo-100 group">
                                <div class="flex items-center">
                                    <div
                                        class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center mr-3 text-sm">
                                        <%= item.icon %>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800 text-sm">
                                            <%= item.name %>
                                        </p>
                                        <p class="text-xs text-gray-400"> Shelf: ~<%= item.shelf %> days</p>
                                    </div>
                                </div>
                                <button type="button"
                                    class="w-8 h-8 rounded-full bg-white border border-gray-200 text-indigo-600 flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-all shadow-sm">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <% }); %>
                </div>
            </div>
        </div>


        <div class="bg-white shadow-lg rounded-xl overflow-hidden">
            <div class="p-5">
                <!-- Pending Items Container (Hidden when empty) -->
                <div id="pending-container" class="mb-8 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-gray-800">Pending Items (<span id="pending-count">0</span>)
                        </h4>
                        <button onclick="submitBatch()" id="submit-batch-btn"
                            class="py-2 px-4 bg-emerald-600 text-white rounded-lg text-sm font-semibold shadow-md hover:bg-emerald-700 transition-colors">
                            Add All Items
                        </button>
                    </div>
                    <div id="pending-list" class="space-y-3">
                        <!-- Pending Items Injected Here -->
                    </div>
                </div>

                <form onsubmit="event.preventDefault(); addManualItem();" id="add-item-form">

                    <!-- Barcode Scanner Trigger & Manual Input -->
                    <div class="mb-6">
                        <button type="button" id="start-scan-btn"
                            class="w-full mb-3 flex justify-center items-center py-4 px-4 border border-emerald-500 border-dashed rounded-xl text-sm font-medium text-emerald-700 bg-emerald-50 hover:bg-emerald-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all active:scale-[0.98]">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-barcode text-2xl mb-1"></i>
                                <span>Scan Barcode</span>
                            </div>
                        </button>

                        <!-- Manual Barcode Fallback (Toggleable or Visible) -->
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-keyboard text-gray-400"></i>
                            </div>
                            <input type="text" name="barcode" id="barcode"
                                class="focus:ring-emerald-500 focus:border-emerald-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-lg py-3"
                                placeholder="Or type barcode manually...">
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Name Input -->
                        <div>
                            <label for="name" class="block text-sm font-semibold text-gray-700 mb-1">Item Name</label>
                            <input type="text" name="name" id="name" required
                                class="appearance-none block w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm transition-shadow"
                                placeholder="e.g. Greek Yogurt">
                        </div>

                        <!-- Quantity Stepper Input -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Number of Products</label>
                            <div
                                class="flex items-center justify-between bg-gray-50 rounded-xl p-2 border border-gray-200">
                                <!-- Minus Button -->
                                <button type="button" onclick="adjustQuantity(-1)"
                                    class="w-14 h-14 flex items-center justify-center rounded-lg bg-white text-gray-500 shadow-sm border border-gray-200 hover:text-red-500 active:bg-gray-100 focus:outline-none transition-all touch-manipulation">
                                    <i class="fas fa-minus text-xl"></i>
                                </button>

                                <!-- Display Value -->
                                <div class="flex-1 text-center select-none">
                                    <span id="quantityDisplay" class="text-3xl font-bold text-gray-800">1</span>
                                    <input type="hidden" name="quantity" id="quantity" value="1">
                                </div>

                                <!-- Plus Button -->
                                <button type="button" onclick="adjustQuantity(1)"
                                    class="w-14 h-14 flex items-center justify-center rounded-lg bg-white text-gray-500 shadow-sm border border-gray-200 hover:text-emerald-500 active:bg-gray-100 focus:outline-none transition-all touch-manipulation">
                                    <i class="fas fa-plus text-xl"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Age Stepper & Shelf Life Grid -->
                        <div class="grid grid-cols-1 gap-6">
                            <!-- Shelf Life Input -->
                            <div>
                                <label for="shelfLife" class="block text-sm font-semibold text-gray-700 mb-1">Shelf Life
                                    (Days)</label>
                                <input type="number" name="shelfLife" id="shelfLife" required min="1"
                                    class="appearance-none block w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm"
                                    placeholder="7">
                            </div>

                            <!-- Age Stepper Input -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">How old is it?
                                    (Days)</label>
                                <div
                                    class="flex items-center justify-between bg-gray-50 rounded-xl p-2 border border-gray-200">
                                    <!-- Minus Button -->
                                    <button type="button" onclick="adjustAge(-1)"
                                        class="w-14 h-14 flex items-center justify-center rounded-lg bg-white text-gray-500 shadow-sm border border-gray-200 hover:text-red-500 active:bg-gray-100 focus:outline-none transition-all touch-manipulation">
                                        <i class="fas fa-minus text-xl"></i>
                                    </button>

                                    <!-- Display Value -->
                                    <div class="flex-1 text-center select-none">
                                        <span id="daysOldDisplay" class="text-3xl font-bold text-gray-800">0</span>
                                        <span class="text-xs text-gray-500 block">days ago</span>
                                        <input type="hidden" name="daysOld" id="daysOld" value="0">
                                    </div>

                                    <!-- Plus Button -->
                                    <button type="button" onclick="adjustAge(1)"
                                        class="w-14 h-14 flex items-center justify-center rounded-lg bg-white text-gray-500 shadow-sm border border-gray-200 hover:text-emerald-500 active:bg-gray-100 focus:outline-none transition-all touch-manipulation">
                                        <i class="fas fa-plus text-xl"></i>
                                    </button>
                                </div>
                                <p class="mt-2 text-center text-xs text-gray-400">0 means bought today</p>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="mt-8">
                        <button type="submit"
                            class="w-full flex justify-center py-4 px-4 border border-transparent rounded-xl shadow-md text-base font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all active:scale-[0.98]">
                            Add to List
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scanner Modal Overlay -->
    <div id="scanner-modal"
        class="fixed inset-0 z-[100] hidden bg-black bg-opacity-95 flex flex-col justify-center items-center">
        <!-- Close Button -->
        <button id="close-scanner" type="button"
            class="absolute top-4 right-4 text-white p-3 rounded-full bg-gray-800 hover:bg-gray-700 focus:outline-none z-[110] touch-manipulation">
            <i class="fas fa-times text-2xl"></i>
        </button>

        <div class="w-full max-w-md px-4 relative flex flex-col h-full justify-center">
            <div class="text-white text-center mb-6">
                <h3 class="text-xl font-bold">Scan Barcode</h3>
                <p class="text-sm text-gray-300">Point camera at a product label</p>
            </div>

            <!-- Scanner Viewport -->
            <div id="reader"
                class="w-full bg-black rounded-2xl overflow-hidden border-2 border-emerald-500 shadow-2xl relative">
            </div>

            <!-- Status Text -->
            <div id="scanner-status" class="text-center mt-6 text-emerald-400 font-medium min-h-[24px]"></div>
        </div>
    </div>

    <script>
        let batchItems = [];

        // Client-side Logic
        function renderBatch() {
            const container = document.getElementById('pending-container');
            const list = document.getElementById('pending-list');
            const countDisplay = document.getElementById('pending-count');

            if (batchItems.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            countDisplay.innerText = batchItems.length;
            list.innerHTML = '';

            batchItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 rounded-lg p-3 border border-gray-200 flex flex-col gap-2';

                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h5 class="font-bold text-gray-800 text-base">${item.name}</h5>
                            <p class="text-xs text-gray-500">Shelf Life: ${item.shelfLife} days</p>
                        </div>
                        <button type="button" onclick="removeFromBatch(${index})" class="text-gray-400 hover:text-red-500 bg-white rounded-full p-1 border border-gray-100 shadow-sm">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mt-1">
                        <!-- Qty Control -->
                        <div class="flex items-center bg-white rounded-lg border border-gray-200">
                             <button type="button" onclick="updateBatchItem(${index}, 'quantity', -1)" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-red-500 active:bg-gray-50 rounded-l-lg touch-manipulation">
                                <i class="fas fa-minus text-xs"></i>
                            </button>
                            <span class="flex-1 text-center text-sm font-bold text-gray-800">${item.quantity}</span>
                            <button type="button" onclick="updateBatchItem(${index}, 'quantity', 1)" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-emerald-500 active:bg-gray-50 rounded-r-lg touch-manipulation">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                        
                        <!-- Age Control -->
                        <div class="flex items-center bg-white rounded-lg border border-gray-200">
                             <button type="button" onclick="updateBatchItem(${index}, 'daysOld', -1)" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-red-500 active:bg-gray-50 rounded-l-lg touch-manipulation">
                                <i class="fas fa-minus text-xs"></i>
                            </button>
                            <div class="flex-1 text-center leading-none">
                                <span class="block text-sm font-bold text-gray-800">${item.daysOld}</span>
                                <span class="block text-[10px] text-gray-400">days old</span>
                            </div>
                            <button type="button" onclick="updateBatchItem(${index}, 'daysOld', 1)" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-emerald-500 active:bg-gray-50 rounded-r-lg touch-manipulation">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function addToBatch(item) {
            // Check if same item already exists (same name & same shelf life & same age)
            // Ideally we separate by unique item entry
            // For simplicity, always add new entry if not exact duplicate
            // But prompt says: "If item exists -> increment quantity"

            const existingIndex = batchItems.findIndex(i => i.name === item.name && i.shelfLife == item.shelfLife && i.daysOld == item.daysOld);

            if (existingIndex > -1) {
                batchItems[existingIndex].quantity += 1;
            } else {
                batchItems.push(item);
            }
            renderBatch();
        }

        function updateBatchItem(index, field, delta) {
            const item = batchItems[index];
            if (field === 'quantity') {
                item.quantity += delta;
                if (item.quantity < 1) item.quantity = 1;
            } else if (field === 'daysOld') {
                item.daysOld += delta;
                if (item.daysOld < 0) item.daysOld = 0;
            }
            renderBatch();
        }

        function removeFromBatch(index) {
            batchItems.splice(index, 1);
            renderBatch();
        }

        async function submitBatch() {
            if (batchItems.length === 0) return;

            try {
                const response = await fetch('/inventory/add-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: batchItems })
                });

                const result = await response.json();

                if (result.success) {
                    batchItems = [];
                    renderBatch();
                    // Just reload or redirect to inventory
                    window.location.href = '/inventory/fresh';
                } else {
                    alert('Error saving items: ' + (result.message || 'Unknown error'));
                }
            } catch (err) {
                console.error(err);
                alert('Network error while saving items.');
            }
        }

        function addManualItem() {
            const name = document.getElementById('name').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const shelfLife = parseInt(document.getElementById('shelfLife').value) || 7;
            const daysOld = parseInt(document.getElementById('daysOld').value) || 0;

            if (!name) {
                alert("Please enter item name");
                return;
            }

            addToBatch({ name, quantity, shelfLife, daysOld });

            // Reset Name for next entry, optional reset others
            document.getElementById('name').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('quantityDisplay').innerText = '1';
            document.getElementById('name').focus();
        }

        // Quick Add Logic
        function fillItem(name, qty, shelf) {
            // Directly add to batch instead of filling form
            addToBatch({ name, quantity: parseInt(qty), shelfLife: parseInt(shelf), daysOld: 0 });

            // Feedback
            const container = document.getElementById('pending-container');
            container.classList.remove('hidden');
            // Small flash effect on container ?
        }

        // Manual helpers
        function adjustQuantity(delta) {
            const input = document.getElementById('quantity');
            const display = document.getElementById('quantityDisplay');
            let val = parseInt(input.value) || 1;
            val += delta;
            if (val < 1) val = 1;
            input.value = val;
            display.innerText = val;
        }

        function adjustAge(delta) {
            const input = document.getElementById('daysOld');
            const display = document.getElementById('daysOldDisplay');
            let val = parseInt(input.value) || 0;
            val += delta;
            if (val < 0) val = 0;
            input.value = val;
            display.innerText = val;
        }

        // Toggle Suggestions
        document.addEventListener('DOMContentLoaded', () => {
            const suggestionsBtn = document.getElementById('toggle-suggestions');
            const suggestionsList = document.getElementById('suggestions-list');
            const suggestionsIcon = document.getElementById('suggestion-icon');

            if (suggestionsBtn) {
                suggestionsBtn.addEventListener('click', () => {
                    suggestionsList.classList.toggle('hidden');
                    suggestionsIcon.style.transform = suggestionsList.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
                });
                suggestionsList.classList.remove('hidden');
                suggestionsIcon.style.transform = 'rotate(180deg)';
            }

            // Scanner Stuff
            const startBtn = document.getElementById('start-scan-btn');
            const closeBtn = document.getElementById('close-scanner');
            const modal = document.getElementById('scanner-modal');
            const statusText = document.getElementById('scanner-status');
            const nameInput = document.getElementById('name');

            let html5QrcodeScanner = null;
            let isScanning = false;

            function openScanner() {
                modal.classList.remove('hidden');
                startScanning();
            }

            function closeScanner() {
                if (html5QrcodeScanner && isScanning) {
                    html5QrcodeScanner.stop().then(() => {
                        modal.classList.add('hidden');
                        isScanning = false;
                        statusText.textContent = '';
                    }).catch(err => {
                        console.error("Failed to stop scanner", err);
                        modal.classList.add('hidden');
                    });
                } else {
                    modal.classList.add('hidden');
                }
            }

            function startScanning() {
                if (!window.isSecureContext) {
                    alert("Camera access requires HTTPS. Please accept any permission prompts.");
                }

                statusText.textContent = "Requesting camera...";
                html5QrcodeScanner = new Html5Qrcode("reader");

                const config = { fps: 10, qrbox: { width: 250, height: 250 } };

                html5QrcodeScanner.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanFailure
                ).then(() => {
                    isScanning = true;
                    statusText.textContent = "Scanning...";
                }).catch(err => {
                    console.error("Error starting scanner", err);
                    statusText.innerHTML = "Error: Camera access denied. HTTPS required.";
                    alert("Camera access failed. Please use the manual barcode field below.");
                    closeScanner();
                });
            }

            async function onScanSuccess(decodedText, decodedResult) {
                if (isScanning) {
                    await html5QrcodeScanner.stop();
                    isScanning = false;
                    modal.classList.add('hidden');
                }

                // If fallback input exists, fill it
                const barcodeInput = document.getElementById('barcode');
                if (barcodeInput) barcodeInput.value = decodedText;

                // Visual loading state
                const originalContent = startBtn.innerHTML;
                startBtn.innerHTML = '<div class="flex flex-col items-center"><i class="fas fa-spinner fa-spin text-2xl mb-1"></i><span>Fetching...</span></div>';
                startBtn.disabled = true;

                try {
                    const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${decodedText}.json`);
                    const data = await response.json();

                    if (data.status === 1 && data.product.product_name) {
                        const name = data.product.product_name;
                        // Add directly to batch
                        // Default qty 1, shelf life ? (use 7 default or try logic)

                        addToBatch({
                            name,
                            quantity: 1,
                            shelfLife: 7, // Default fallback
                            daysOld: 0
                        });

                        alert(`Added "${name}" to pending list.`);
                    } else {
                        alert("Product scanned but details not found. Please enter name manually.");
                        nameInput.focus();
                    }
                } catch (error) {
                    console.error("API Error", error);
                    alert("Scan successful, but could not fetch details.");
                } finally {
                    startBtn.innerHTML = originalContent;
                    startBtn.disabled = false;
                }
            }

            function onScanFailure(error) {
                // ignore
            }

            if (startBtn) startBtn.addEventListener('click', openScanner);
            if (closeBtn) closeBtn.addEventListener('click', closeScanner);
        });
    </script>

    <%- include('../partials/footer') %>